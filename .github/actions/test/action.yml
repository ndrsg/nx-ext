name: Test

description: Test

inputs:
  codecov_token:
    description: Codecov token
    required: true

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

runs:
  using: composite

  steps:
    - name: Commitlint
      shell: bash
      run: npx commitlint --from=$(git show-ref --tags | grep release- | tail -n 1 | sed 's~.* refs/tags/~~')
    - name: Lint
      shell: bash
      run: npx nx affected:lint --base=$(git show-ref --tags | grep release- | tail -n 1 | sed 's~.* refs/tags/~~')
    - name: Build
      shell: bash
      run: npx nx affected:build --base=$(git show-ref --tags | grep release- | tail -n 1 | sed 's~.* refs/tags/~~')
    - name: Test
      shell: bash
      run: npx nx affected:test --code-coverage --base=$(git show-ref --tags | grep release- | tail -n 1 | sed 's~.* refs/tags/~~')
    - name: E2E
      shell: bash
      run: npx nx affected:e2e --base=$(git show-ref --tags | grep release- | tail -n 1 | sed 's~.* refs/tags/~~')
    - name: Codecov upload
      uses: codecov/codecov-action@v2
      with:
        token: ${{ inputs.codecov_token }}
